本地内存导致的可见性问题

一个线程对共享变量的修改，另外一个线程能够立刻看到，称为可见性。但是本地内存的出现使得可见性可能受到破坏。

本地内存（Local Memory）是JMM的一个抽象概念，线程私有，存储了该线程读写变量的副本，对应于主内存（Main Memory）的概念。但是这只是一个抽象概念，并不物理存在，它涵盖了缓存、写缓冲区、寄存器其他编译器和硬件优化。我们常常可以见到以下这张“JMM内存模型的抽象结构示意图”，较为贴切地说明了本地内存和主内存的关系。
![image.png](https://upload-images.jianshu.io/upload_images/9341275-76422a535e8d8ffa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

为什么需要本地内存？既然本地内存不真实存在，我们就以CPU多级缓存为例解释。CPU的频率很快，但是主存的速度较慢无法匹配，导致CPU常处于空闲中浪费资源。所以多级缓存出现，是为了缓解CPU和内存之间速度的不匹配问题。背后的原理也是我们耳熟能详的：局部性原理。

>局部性原理表现为：时间局部性和空间局部性。
>时间局部性是指如果程序中的某条指令一旦执行，则不久之后该指令可能再次被执行；如果某数据被访问，则不久之后该数据可能再次被访问。
>空间局部性是指一旦程序访问了某个存储单元，则不久之后。其附近的存储单元也将被访问。